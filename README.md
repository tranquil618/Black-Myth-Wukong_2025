黑神话悟空游戏说明文档
---
1. 项目信息
- 项目名称：黑神话：悟空（Black Myth: Wukong）
- 开发引擎：Cocos2d-x
- 核心语言：C++
- 项目GitHub地址：https://github.com/tranquil618/Black-Myth-Wukong_2025
---

2. 游戏介绍
- 游戏描述：
  该项目是基于近期火爆游戏《黑神话：悟空》设计与实现的，旨在为玩家提供一个沉浸式的东方神话主题战斗冒险体验。玩家可操纵“悟空”角色，进行探索、战斗、闪避、法术释放、变身等多种操作，与不同妖怪、Boss对战，并可体验关卡剧情和场景切换。
- 角色设定：
  - 玩家主角（Maria）：具备基础属性（生命值、攻击力、特技点等）框架，战斗风格以灵活近战为主。
  - 敌人与BOSS：3种小怪类型，具备不同攻击力和攻击招数；BOSS带技能变化，可进入二阶段。
- 场景与地图：
  - 共有神殿、斗兽场两个核心场景，支持场景切换功能。
  - 背景音乐支持动态切换。
---

3. 程序整体设计与架构
总体架构设计：
采用模块化分层设计，核心遵循“主场景统筹+功能模块解耦”的架构思路。整体可划分为核心控制层、实体层、控制层、UI层四大层级，各层级间通过接口调用、实例持有、事件触发实现交互。

3.1 核心控制层
HelloWorldScene.cpp（主场景控制器）
负责所有游戏元素的生命周期管理、逻辑调度与交互协调，是所有模块的入口与核心统筹模块。

1. 初始化阶段（init() 函数）
按“基础环境→核心实体→交互系统”的顺序完成全场景初始化，具体子流程如下：
| 子函数名          | 功能                                                                 |
|-------------------|--------------------------------------------------------------------------|
| setupCamera()     | 1.创建第三人称透视相机并设置视锥参数60° FOV；<br>2.绑定USER1相机标志，用于后续渲染层级控制；<br>3.将相机加入场景节点树，作为主视角使用。 |
| setupPlayer()、setupEnemies()    | 1. 实例化Maria角色对象配置 3D 缩放；<br>2. 初始化角色初始状态（IDLE）与HP值，将角色节点添加到场景。<br>3.调用EnemyFactory工厂类的createEnemy()方法，分别创建地精（Goblin）、骑士（Knight）、牛头人（Minotaur）三种敌人实例；<br>4.设置敌人初始位置并统一绑定玩家为攻击目标,将敌人对象集中存入容器进行统一管理。|
| setupEnvironment()| 1. 加载天空模型，设置无限远渲染层级；<br>2. 加载寺庙3D模型，调整位置与缩放；<br>3. 加载传送门模型，设置触发判定范围；<br>4. 初始化粒子特效（如光影、烟尘），绑定到对应场景节点。 |
| setupUI()         | 构建 _pauseLayer 遮罩层，预置各类回调按钮及胜负结算文本。 |

2. 帧更新阶段（update(float dt) 函数）
每帧执行的核心逻辑循环，按“状态校验→逻辑更新→条件检测”的顺序执行：
1. 状态校验：
   - 检测是否触发暂停
   - 检测玩家HP值
   - 检测Boss是否死亡
2. 逻辑更新：
   - 调用PlayerInputController处理玩家键盘/鼠标输入
   - 调用TPSCameraController更新相机位置，保持跟随玩家
   - 遍历_enemies容器，更新敌人的移动、攻击、状态判定逻辑
   - 清理容器中已死亡的敌人
3. 条件检测：
   - 调用checkPortalTeleport()计算玩家与传送门的距离，满足条件时触发场景切换逻辑

3. 场景切换逻辑（checkPortalTeleport() 函数）
实现从“神殿场景”到“斗兽场场景”的过渡，具体步骤：
1. 隐藏神殿模型、普通敌人节点，停止对应粒子特效；
2. 加载斗兽场3D模型，设置位置与缩放，绑定USER1相机可见掩码；
3. 创建Boss并单独管理，设置其攻击目标为Maria；
4. 调整相机初始位置，适配斗兽场场景视野。

4. 辅助功能
- 暂停/恢复逻辑：通过_setPause(bool isPause)方法控制_pauseLayer的显隐，同步暂停/恢复背景音乐与游戏循环；
- 场景重启/退出：绑定按钮回调，重启时重新调用init()方法重置所有状态，退出时调用Director::getInstance()->end()关闭程序。

---
3.2 实体层

3.2.1玩家（悟空）角色设计
 1. 类结构与继承关系
悟空角色由 Maria 类实现，通过继承 cocos2d::Sprite3D 并实现自定义 Player 接口，该类集成了动作系统的所有关键逻辑。

 2.  角色状态机设计
 - 状态定义：枚举MariaState包含11种核心状态：
   - 基础状态：空闲（IDLE）、行走（WALK）、奔跑（RUN）、跳跃（JUMPING）
   - 战斗相关状态：攻击（ATTACKING）、技能释放（SKILLING）、闪避（DODGING）、受击（HURT）、死亡（DEAD）
   - 防御与姿态状态：格挡（BLOCK_IDLE）、蹲伏（CROUCH_IDLE）
- 状态切换：
   - 提供setState(MariaState newState)方法，禁止重复设置相同状态（对比_currentState与newState）；
   - 切换时记录旧状态（oldState），用于状态恢复（如攻击结束后回到IDLE）；
- 不同状态绑定不同逻辑：
    - IDLE/WALK/RUN：控制移动速度，播放对应动画，停止攻击状态；
    - ATTACK：触发攻击判定框，播放攻击动画，记录攻击基准位置；
    - HURT：扣减HP值，停止移动/攻击，播放受伤动画；
    - DEAD：设置死亡标记，触发失败逻辑。 
  
3. 具体功能设计
- 攻击、连招与缓冲系统：
  - 三段式攻击设计：通过 getComboData() 函数为每一段攻击分配不同的位移距离（distance）和持续时间（duration），实现分段打击感，保证动作自然平滑。
  - 输入缓冲逻辑：在 handleComboEnd() 中检查缓冲位，确保角色能平滑衔接下一段连招。
- 影子技能：
  - 多对象协作：通过 spawnGhostShadow 动态创建多个不带 update 逻辑的 Maria 实例，在角色周围依次生成多个残影。
  - 异步伤害判定：利用 Lambda 表达式与 Sequence 动作，每个残影播放独立攻击动画并进行范围伤害判定。
  ```
  auto damageLogic = CallFunc::create([this, ghost]() {
    // 计算残影位置与周围敌人的距离，执行 takeDamage
  });
  ```
- 移动与相机联动：
  - 为了实现精确的第三人称操控，角色根据相机视角的 Y 轴旋转角度进行向量转换，移动过程中角色自动朝向移动方向旋转。
  
---
3.2.2敌人系统
 1. 小怪
 共有三种小怪角色，具备不同攻击力和生命值。

（1）基类：EnemyBase.h/cpp
 定义所有小怪的通用接口与基础属性，采用纯虚函数规范派生类行为。
 核心设计：
 - 属性：HP、攻击伤害、移动速度、攻击冷却时间、当前状态（IDLE/CHASE/ATTACK/DEAD）、目标对象（Maria*）；
 - 通用行为函数：
   - setTarget(Maria* target)：绑定攻击目标；
   - isDead()：判断是否死亡（HP≤0）；
   - chaseTarget()：向目标移动的通用逻辑；
   - takeDamage(int damage)：扣减HP，触发受伤逻辑。

（2）派生类：EnemyGoblin/EnemyKnight/EnemyMinotaur.h/cpp
 继承EnemyBase，实现差异化的敌人行为：
 - EnemyGoblin（哥布林）：低HP、高移动速度、近战快速攻击，doAttack()实现短距离冲刺攻击；
 - EnemyKnight（骑士）：中HP、中移动速度、带格挡判定，doAttack()实现挥砍攻击，格挡时减免伤害；
 - EnemyMinotaur（牛头人）：高HP、低移动速度、范围攻击，Boss版额外增加范围震地攻击，doAttack()实现蓄力砸地攻击。

（3）工厂类：EnemyFactory.h/cpp
 为了降低主场景与敌人派生类的耦合耦合度，项目引入了工厂模式(EnemyFactory)来管理敌人的创建。
 - 根据EnemyType枚举（GOBLIN/KNIGHT/MINOTAUR/BOSS_MINOTAUR）创建对应派生类实例；
 - 提供静态方法createEnemy(EnemyType type, Vec3 position)；
 - 统一初始化敌人位置、基础属性、相机掩码，返回EnemyBase*类型指针，便于统一管理。

---
 2. Boss
（1）角色状态机设计
 Boss 采用基于状态机（State）的行为控制方式，主要状态包括：
 IDLE：闲置等待状态
 WALK / RUN：向玩家移动（狂暴状态下速度提升）
 ATTACK：攻击执行状态
 DODGING：闪避状态
 RAGING：狂暴过渡状态
 DEAD：死亡状态

（2）决策逻辑
 在每帧 update() 中，Boss 根据与玩家的距离、攻击冷却时间及当前状态，动态选择行为：
 - 距离过远时自动向玩家移动并调整朝向
 - 进入攻击范围后，根据冷却时间执行攻击
 - 攻击类型支持随机选择
 - 非狂暴状态下，受到攻击概率触发闪避动作
  
（3）二阶段（怒气状态）
 当 Boss 血量低于最大值的一半时，调用 `enterRageMode()`，将自动进入怒气状态：

 - 播放专属咆哮动画作为过渡表现
 - 攻击冷却时间缩短
 - 移动速度与攻击强度提升
 - 
（4）受击反馈与视觉增强
 - 受击红闪：Boss 受到攻击时会触发受击视觉反馈（闪烁效果），为玩家提供清晰的受击反馈
 - 消亡处理：血量归零后进入死亡状态，执行 Die() 逻辑，播放死亡动画并逐渐淡出
---

 3.3 控制层
1. TPSCameraController（第三人称相机控制器）
该控制器负责3D视角下的镜头管理，用于相机跟随逻辑。
核心功能：
- 构造函数注入Maria角色实例与相机实例，绑定跟随目标；
- 通过偏航角（Yaw）计算相机在角色周围的位置，使用插值方式平滑相机运动，避免生硬跳变，跟随角色旋转；
- 提供setFollowDistance(float distance)方法，支持动态调整相机距离。

2. PlayerInputController（玩家输入控制器）
处理所有玩家输入，转换为角色指令。
核心功能：
- 构造函数注入Maria角色实例与相机实例；
- update(float dt)方法检测键盘/鼠标输入：
  - W/A/S/D键：控制角色移动方向；
  - Shift键：切换WALK/RUN状态；
  - Q键：切换蹲伏状态；
  - X键：触发跳跃动作。
  - 1键：释放影子技能；
  - 空格键：触发JUMPING/DODGING状态；
  - Esc键：触发游戏暂停 / 恢复；
  - 鼠标左键：触发角色ATTACK状态；
  - 鼠标移动：控制相机旋转，同步角色朝向。
  
---
3.4 UI层
所有UI元素均为HelloWorldScene的成员变量，由主场景统一管理：
- 暂停界面（_pauseLayer）：包含半透明遮罩、标题文本、功能按钮，按钮点击触发pause/resume/restart/quit回调；
- 胜利/失败文本：基于玩家/Boss状态动态显隐，设置大字体、高亮颜色（胜利：绿色，失败：红色）；
- 所有UI节点均设置为2D节点，绑定UI专属相机掩码，确保在3D场景上正确叠加显示。
---

4. 功能完成情况
 4.1 基础功能
 - 角色系统：
   - 支持主角模型（悟空）
   - 支持基础动作：行走、奔跑、跳跃、翻滚/闪避、基础攻击（连招3段）
   - 支持基础状态切换
 - 战斗系统：
   - 悟空生命值
   - 敌人生命值
   - 受击硬直反馈
   - 至少一种技能
   - 战斗判定：攻击范围判定、实时碰撞检测、血条显示
 - 敌人与 Boss：
   - 3 种普通怪物
   - 1 个 Boss（带技能/阶段变化）
   - 敌人具备基本 AI：追击、闪避、Boss具备怒气状态/第二阶段
 - 场景功能：
   - 支持 3D 场景移动
   - 包含战斗区域、场景切换点
   - 支持场景动态音乐
 - UI功能：
   - 标题菜单
   - Boss 血条
   - 玩家血条
   - 技能冷却
   - 死亡重开
   - 暂停/继续菜单
 - 程序中涉及的部分C++特性：
   - Lambda表达式
   - auto关键字
   - 继承与多态
   - 动态类型转换
   - STL容器：vector、map
  
 4.2 扩展功能
 - Maria具备影分身功能
 - Boss 怒气/时间阶段切换
 - 可动视角
 - 增加了向前、向左、向右的闪避
 - Boss二阶段血条震动

---
 5. 成员分工

| 姓名 | 学号 | 贡献度 | 分工 | 
| 林煜程| 2452650 | 25％ | 主角系统开发 |
| 祝宸旭 | 2451770 | 25％ | 场景与交互设计开发 |
| 吕佩琦 | 2453612 | 25％ | Boss系统开发 |
| 王子墨 | 2454272 | 25％ | 小怪系统开发 |

